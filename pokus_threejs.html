<!DOCTYPE html>
<html>
    <head>
        <title>ThreeJS 360 Panorama</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
        <style>
			html {
				text-align: center;
			}	
            #demo{
				position: static;
                margin: 0;
				padding: 0;
                cursor: move; 
                cursor: grab;
                cursor: -moz-grab;
                cursor: -webkit-grab;
            }
            #demo:active { 
                cursor: grabbing;
                cursor: -moz-grabbing;
                cursor: -webkit-grabbing;
            }
            #log{
                position: absolute;
                background: #fff;
                padding: 20px;
                top: 20px;
                left: 20px;
                width: 150px;
                font: normal 12px/18px Monospace, Arial, Helvetical, sans-serif;
                text-align: left;
                border: 3px double #ddd;
            }
			 #save_button{
                position: absolute;
                background: #fff;
                padding: 10px;
                top: 20px;
                right: 50px;
                height: 30px;
				width: 200px;
                font: normal 12px/18px Monospace, Arial, Helvetical, sans-serif;
                text-align: center;
            }
			
        </style>
    </head>
    <body oncontextmenu="return false;">
        <div id="demo">
            <div id="log"></div>
			<button id="save_button" onclick="saveCSV(); openNextSlide();">Save</button>	
        </div>  
		<script src="./scripts/three.min.js"></script>		
		<script src="./scripts/jquery-1.11.2.js"></script>
		<script src="./scripts/save_new_csv.js"></script>
		<script src="./scripts/save_to_existing_csv.js"></script>
		<!--<script src="./scripts/detect_keys.js"></script> -->     
        <script>
		//upraveno pro testovani
		var userId = location.search.substring(8);

		var taskL = "D";
		var taskOr = 1; 
	
		var file_name1 = 'move_D_' + userId + '.csv';
		//var file_name2 = 'all_task_D.csv';
		//var file_name3 = 'task_D_' + userId + '.csv';
		//var file_name4 = 'task_all_' + userId + '.csv';

		//var mouse = { x: 0, y: 0 };

		//document.addEventListener("keydown", detectKey);
		
		var camera,
        scene,
        element = document.getElementById('demo'), // Inject scene into this
        renderer,
        onPointerDownPointerX,
        onPointerDownPointerY,
        onPointerDownLon,
        onPointerDownLat,
        fov = 75, // Field of View
        isUserInteracting = false,
        lon = 0,
        lat = 0,
        phi = 0,
        theta = 0,
        onMouseDownMouseX = 0,
        onMouseDownMouseY = 0,
        onMouseDownLon = 0,
        onMouseDownLat = 0,
        width =  (window.innerWidth - 50),
        height = (window.innerHeight - 50),
        ratio = width / height;
		
		var meshes = [];
		
		//zaznam virtualniho pohybu - funkce
		var move_type;
		var a = []; // virtual movement
		//var b = []; // answer
		//var c = []; // place transmiter
		//var d = []; //detect errors
		var time = 0;
		var numClick = 1;
		
		setInterval(function() {
			time = time + 10;			
		}, 10);

	function saveCSV() {
			//var worldCamera = app.scene.toMapCoordinates(app.camera.position.x, app.camera.position.y, app.camera.position.z);
			//var worldTarget = app.scene.toMapCoordinates(app.controls.target.x, app.controls.target.y, app.controls.target.z);
			a.push([time, camera.position.x, camera.position.y, camera.position.z, fov]);
			//b.push([userId, taskL, parseInt(taskOr), history.length, time, "end", numClick]);
			//c.push([time, "end", numClick]);
			//d.push([userId, taskL, parseInt(taskOr), history.length, time, "end", numClick]);
	
			saveDataToNewFile(file_name1, arrayToCSV(a));
			//saveDataToExistingFile(file_name2, arrayToCSV(b));
			//saveDataToNewFile(file_name3, arrayToCSV(c));	
			//saveDataToExistingFile(file_name4, arrayToCSV(d));
	}
	function arrayToCSV(input) {
		var row, cell
		var csv = "";
		for (i = 0; i < input.length; ++i) {
			row = input[i];
			for (j = 0; j < row.length; ++j) {
				cell = input[i][j] + ";";
				csv = csv + cell;
			}
			csv = csv + "\n"; 
		}
		csv = csv.replace(/\./g, ',');
		return csv;
	}
//zaznam virtualniho pohybu - funkce - konec
		

	var texture = THREE.ImageUtils.loadTexture('scenes/panorama_chodba.png', new THREE.UVMapping(), function() {
			init();
			animate();
	});
	function init() {
		camera = new THREE.PerspectiveCamera(fov, ratio, 1, 1000);
		scene = new THREE.Scene();
		var mesh = new THREE.Mesh(new THREE.SphereGeometry(500, 60, 40), new THREE.MeshBasicMaterial({map: texture}));
		mesh.scale.x = -1;
		scene.add(mesh);
		meshes.push(mesh);
	
		var plane1 = new THREE.Mesh(new THREE.PlaneGeometry(125, 150), new THREE.MeshBasicMaterial({color: 0xffff00, opacity: 0.5, transparent: true}));
		plane1.material.side = THREE.DoubleSide;
		plane1.position.x = -325;
		plane1.position.y = 0;
		plane1.position.z = 300;
		plane1.rotation.y = ((Math.PI / 2) + (Math.PI / 3));
		scene.add(plane1);
		meshes.push(plane1);
		
		var plane2 = new THREE.Mesh(new THREE.PlaneGeometry(125, 150), new THREE.MeshBasicMaterial({color: 0xff0000, opacity: 0.5, transparent: true}));
		plane2.material.side = THREE.DoubleSide;
		plane2.position.x = -325;
		plane2.position.y = 0;
		plane2.position.z = -300;
		plane2.rotation.y = ((Math.PI / 2) - (Math.PI / 3));
		scene.add(plane2);
		meshes.push(plane2);

		renderer = new THREE.WebGLRenderer({antialias: true});
		renderer.setSize(width, height);
		element.appendChild(renderer.domElement);
		element.addEventListener('mousedown', onDocumentMouseDown, false);
		element.addEventListener('mousewheel', onDocumentMouseWheel, false);
		element.addEventListener('DOMMouseScroll', onDocumentMouseWheel, false);
		element.addEventListener("click", onSceneClick, false);
		
		window.addEventListener('resize', onWindowResized, false);
		
		onWindowResized(null);		
		
	}
	
	function onSceneClick(event) {
		
			numClick = numClick + 1;
			
			event.preventDefault();
			// update the mouse variable
			
			var mouse;// = new THREE.Vector2();
			var rect = renderer.domElement.getBoundingClientRect();
			mouse.x = ( ( event.clientX - rect.left ) / ( rect.width - rect.left ) ) * 2 - 1;
			mouse.y = - ( ( event.clientY - rect.top ) / ( rect.bottom - rect.top) ) * 2 + 1;
			//mouse.z = 0.5;
			
			//mouse.x = ( event.clientX / renderer.domElement.clientWidth ) * 2 - 1;
			//mouse.y = - ( event.clientY / renderer.domElement.clientHeight ) * 2 + 1;
			
			//var camCoord = new THREE.Vector3();
			//camCoord.x = camera.position.x;
			//camCoord.y = camera.position.y;
			//camCoord.z = camera.position.z;
			
			var vector = new THREE.Vector3( mouse.x, mouse.y, 0.5 );
            projector.unprojectVector(vector, camera);
			
			var raycaster = new THREE.Raycaster(camera.position, vector.sub( camera.position ).normalize());
			//raycaster.setFromCamera(mouse, camera);
			raycaster.set(camera.position, vector.sub( camera.position ).normalize());
			//window.alert("X: " + camCoord.x + " Y: " + camCoord.y + " Z: " + camCoord.z + " ");
			window.alert(raycaster.far);
			var intersects = raycaster.intersectObjects(meshes);
			
			if (intersects.length > 0) {
				for ( var i = 0; i < intersects.length; i++ ) {
					window.alert("" + intersects[i].point + "");
				}
			}
				else  { 
					window.alert("clicked outside the mesh");
			}	
			
	}
	

	function onWindowResized(event) {
		//    renderer.setSize(window.innerWidth, window.innerHeight);
		//    camera.projectionMatrix.makePerspective(fov, window.innerWidth / window.innerHeight, 1, 1100);
			renderer.setSize(width, height);
			camera.projectionMatrix.makePerspective(fov, ratio, 1, 1100);
	}
	function onDocumentMouseDown(event) {
			event.preventDefault();
			onPointerDownPointerX = event.clientX;
			onPointerDownPointerY = event.clientY;
			onPointerDownLon = lon;
			onPointerDownLat = lat;
			isUserInteracting = true;
			element.addEventListener('mousemove', onDocumentMouseMove, false);
			element.addEventListener('mouseup', onDocumentMouseUp, false);
	}
	function onDocumentMouseMove(event) {
			lon = (event.clientX - onPointerDownPointerX) * -0.175 + onPointerDownLon;
			lat = (event.clientY - onPointerDownPointerY) * -0.175 + onPointerDownLat;
	}
	function onDocumentMouseUp(event) {
			isUserInteracting = false;
			element.removeEventListener('mousemove', onDocumentMouseMove, false);
			element.removeEventListener('mouseup', onDocumentMouseUp, false);
	}
	function onDocumentMouseWheel(event) {
		// WebKit
    if (event.wheelDeltaY) {
        fov -= event.wheelDeltaY * 0.05;
        // Opera / Explorer 9
    } else if (event.wheelDelta) {
        fov -= event.wheelDelta * 0.05;
        // Firefox
    } else if (event.detail) {
        fov += event.detail * 1.0;
    }
    if (fov < 45 || fov > 90) {
        fov = (fov < 45) ? 45 : 90;
    }
    camera.projectionMatrix.makePerspective(fov, ratio, 1, 1100);
}
	function animate() {
			requestAnimationFrame(animate);
			render();
	}
	function render() {
			lat = Math.max(-85, Math.min(85, lat));
			phi = THREE.Math.degToRad(90 - lat);
			theta = THREE.Math.degToRad(lon);
			camera.position.x = 100 * Math.sin(phi) * Math.cos(theta);
			camera.position.y = 100 * Math.cos(phi);
			camera.position.z = 100 * Math.sin(phi) * Math.sin(theta);
			
			var log = ("x: " + camera.position.x);
			log = log + ("<br/>y: " + camera.position.y);
			log = log + ("<br/>z: " + camera.position.z);
			log = log + ("<br/>fov: " + fov);
			document.getElementById('log').innerHTML = log;
			
			a.push([time, camera.position.x, camera.position.y, camera.position.z, fov]);
			
			camera.lookAt(scene.position);
			renderer.render(scene, camera);
	}
	
	function openNextSlide() {
		setTimeout(function() {
			window.open("001_end.html", "_self");
		}, 750);
	}
	</script> 
    </body>
</html>