<html>
 <head>
        <title>A-Frame 360 Panorama</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<script src="./scripts/aframe.min.js"></script>
		<script src="./scripts/jquery-1.11.2.js"></script>
		<script src="./scripts/common.js"></script>
</head>
<body oncontextmenu="return false;">
    <script>
        var taskOr = getParameterByName('taskOr');
        var taskCount = getParameterByName('taskCount');
        var userId = getParameterByName('userId');

        var responsesFile = userId + '_responses.csv';
        var interactionFile = userId + '_interaction.csv';
        //document.addEventListener("keydown", detectKey);
        
        var move_type;
        var interaction = []; // virtual movement = rotation
        var responses = []; // click
        var time = 0;
        
        setInterval(function() {
            time = time + 10;
        }, 10);
    
        var myVar = setInterval(counter, 10);
        function counter (){
            timerValue = timerValue - 10;
            var sceneEl = document.querySelector('a-scene');
            if (timerValue > 0 ) {
                sceneEl.querySelector("#counterText").setAttribute('text', {width: 1.5, height: 1.5, align: 'center', color: 'red', value: '' + (timerValue/1000).toFixed(2) + ' s'}, true);
            }
            else  {
                sceneEl.querySelector("#counterText").setAttribute('text', {width: 1.5, height: 1.5, align: 'center', color: 'red', value: '0.00 s'}, true);
                clearInterval(myVar);
                responses.push(["training1", userId, null, null, null, null, null]);
                saveDataToNewFile(responsesFile, arrayToCSV(responses));
                saveDataToNewFile(interactionFile, arrayToCSV(interaction));
                setTimeout(function() {
                    window.open("003_training2.html?taskOr=" + taskOr + "&taskCount=" + taskCount + "&userId=" + userId, "_self");
                }, 250);
            }
        };
    
        AFRAME.registerComponent('clickhandler', {
            schema: {
              txt: {default:'default'}
            },
            init: function () {
              var data = this.data;
              var el = this.el;
              el.addEventListener('click', function (evt) {   //dblclick
                //window.alert(data.txt);
                //window.alert(evt.detail.intersection.point.x);
                responses.push(["training1", userId, time, data.txt, evt.detail.intersection.point.x, evt.detail.intersection.point.y, evt.detail.intersection.point.z]);
                if ((data.txt == "corridor_left") || (data.txt == "corridor_right")) {
                    saveDataToNewFile(responsesFile, arrayToCSV(responses));
                    saveDataToNewFile(interactionFile, arrayToCSV(interaction));
                    setTimeout(function() {
                        window.open("003_training2.html?taskOr=" + taskOr + "&taskCount=" + taskCount + "&userId=" + userId, "_self");
                    }, 250);
                }
              });
            }
        });
        
        AFRAME.registerComponent('rotation-reader', {
            tick: function () {
                interaction.push(["training1", userId, time, "rotate", this.el.object3D.rotation.x, this.el.object3D.rotation.y]);
                //getWorldPosition(position);
                //getWorldQuaternion(...);
            }
        });

        </script> 
<a-scene>
    <a-entity id="rig" position="0 0 0">
        <a-camera id="camera" look-controls rotation-reader>	
                <a-entity id="counterText" geometry="primitive: plane; height: 0.1; width: 0.5" position="0 -0.7 -1" material="color: white; opacity: 0.5" text="width: 1.5; height: 1.5; align: center; color: red; value: 3.00 s;"></a-entity>
        </a-camera>
    </a-entity>
    <a-sky clickhandler="txt:backgr" src="scenes/01_L-EE0_R-EE0.png" rotation="0 -90 0"></a-sky>
    <a-plane clickhandler="txt:corridor_left" position="-6 1 -11" rotation="0 40 0" width="12" height="12" color="#0000ff" transparent="true" opacity="0.25"></a-plane>
    <a-plane clickhandler="txt:corridor_right" position="6 1 -11" rotation="0 320 0" width="12" height="12" color="#ff0000" transparent="true" opacity="0.25"></a-plane>
    <a-entity cursor="rayOrigin:mouse"></a-entity>		  
</a-scene>
</body>
</html> 